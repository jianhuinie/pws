# 介绍
---

## 操作步骤
---
### 第一步 配置package.json
```
{
    "dependencies": {
        "fe-delta": "^0.1.0"
    }
}
```
### 第二步 拷贝loader.js
把`loader.js`拷贝到本地对应目录，作为线上requirejs的替代方案

### 第三步 配置manifest.js


## 功能列表
---
* html/js/css增量构建和发布，也支持全量发布
* js和插件css/tpl增量下载

## 文件说明
### manifest.js
---
* `fe-delta`生成
* version: js文件id和md5对应关系
* deps: js依赖关系
* rootPath: js加载域名
* enableCombo: js是否合并请求，合并请求，需要结合`nginx-http-concat`
* prefixKey: 用于同一域名多个项目，通过prefixKey匹配，避免重复删除，详见`delta.config.js`

### loader.js
---
前端加载js的模块加载器，替代`requirejs`  
* 增量加载js
* 增量加载插件css/tpl
* 上述文件使用localStorage做浏览器缓存
* xss防护

### delta.config.js
---
构建配置文件，详见`delta.config.js`配置说明

### build.js
---
调用方式，支持参数

## 限制
---
* [建议]项目中需要使用require-css引入css
* 支持amd，所以lib/dep需要手动修改
* 服务端依赖nginx-http-concat模块
* 模板引入扩展名目前只支持.tpl，暂时不支持指定，更不支持.html(和页面扩展名冲突)

## 待实现功能列表
---
### 总体
---
* ~~回滚方案~~
* ~~require([])各种场景的处理，包括：~~
```
require([
    'a',
    'b'
])
require(
    [
        'a',
        'b'
    ]
)
```
* ~~全站时间统计~~
* ~~拷贝增量~~
* ~~多线程处理，js/css分开线程处理，或者js多个线程处理~~
* ~~支持配置文件，m1/m2同一套构建文件~~
* ~~发布到npm~~
* 过滤指定目录，例如：demo/activity之类
* xss防护
* 字符增量
* css是否有必要做增量
* toUrl是否更通用，现在支持图片、flash和mp3，比较死
* `loader.js`统一管理
* `manifest.js`怎么统一
* 处理`fe-tree`的时候，正则是`file`会把`data-file`也处理了
* css处理引入`autoprefixer`
* ~~test环境错误回滚导致全量无效~~
* 已删除文件怎么通知前端把localStorage删除，不用reloadData，会导致每次加载页面都重新下载
* 注意浏览器启用CSP（Content Security Policy）对eval的影响
* `{{}}`有各种场景
* 结合webpack，利用webpack强大功能，例如：CSS Modules的支持
* 下面这部分代码怎么优化
```javascript
(function (global) {
    var GSX_CONFIG = null;
    var require_config = null;
    var cbs = [];
    function isReady() {
        return GSX_CONFIG && require_config;
    }

    function check() {
        if (isReady()) {
            var cb;
            while (cb = cbs.shift()) {
                cb(GSX_CONFIG);
            }
        }
    }
    global['GSX_INIT'] = function (config) {
        global['GSX_INIT'] = null;
        GSX_CONFIG = config;
        var cb;
        while (cb = cbs.shift()) {
            cb(GSX_CONFIG);
        }
    };
    
    global['gsx_ready'] = function (callback) {
        if (isReady()) {
            callback(GSX_CONFIG, require_config);
        } else if ('function' == typeof callback) {
            cbs.push(callback);
        }
    };
    global['initRequireConfig'] = function (config) {
        config['root_path'] = '{{ $static_origin }}/';
        if (require._config) {
            require._config(config);
        }
        require_config = config || true;
        check();
    };
})(window);
```

### css
---
* 支持`@import`和样式混用，样式独立文件；
* 非插件css，实现增量打包和下载；
* 支持非stylus之外的其他预编译样式，至少包含sass、less；
* 构建和loader打通，例如：对css判断，依赖`_pluginCss`
* `url`支持相对路径，例如：/Users/hanrui/work/bjhl/web/web-fe/src/userCenter/teacherCenter/dataCenter/transactionData/transactionData.styl中`./image/down.svg`

### localStorage
---
* ~~localStorage共享~~
* ~~localStorage统一管理：CRUD~~
* 有没有localStorage的替代方案，那个效率更高，例如：Service Workers等
* 前端xss防护：字符串长度、关键字过滤、hash匹配(效率问题)...
* 失效问题：activity是否缓存，已下线页面缓存清除机制(手动维护列表，还是做到程序自动化)

### loader.js
---
* ~**loader.js中使用webworker**~
* 循环依赖的问题
* 支持UMD
* loaderjs无缝支持requirejs，达到开发和线上运行方式一致


### 第三方参考
---
* webpack-bundle-analyzer
* tree shaking