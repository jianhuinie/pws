const path = require('path');
// const Promise = require('promise');
const exec = require('child_process').exec;

const util = require('./util');
const comUtil = require('../util');
const config = require('../config');

function getChangeFiles(data) {
    const baseUrl = config.projectRoot;
    var changeFiles = {
        delFiles: [],
        uptFiles: []
    };
    if (data) {
        var files = data.split('\n');
        files.forEach(function (file) {
            var statusName = file.split('\t');
            if (statusName.length === 2) {
                switch (statusName[0]) {
                    // 修改 & 新增
                    case 'M':
                    case 'A':
                        changeFiles.uptFiles.push(statusName[1]);
                        break;
                    case 'D':
                        changeFiles.delFiles.push(statusName[1]);
                        break;
                }
            }
        });
        changeFiles.uptFiles = changeFiles.uptFiles.map(function (item) {
            return path.join(baseUrl, item);
        });
        changeFiles.delFiles = changeFiles.delFiles.map(function (item) {
            return path.join(baseUrl, item);
        });
    }
    return changeFiles;
}
/**
 * 获取改变的文件
 */
module.exports = function (done, fail) {
    // var gitCmd = 'git diff --name-status HEAD~1 HEAD~0';
    var preCommitId = config.args.preCommitId || 'HEAD~1';
    var lastCommitId = config.args.lastCommitId || 'HEAD~0';
    var gitCmd = 'git diff --name-status ' + preCommitId + ' ' + lastCommitId;
    exec(gitCmd, function (error, data) {
        try {
            console.log('change files');
            if (error) {
                console.error(error);
                fail(error);
                return;
            }
            done(getChangeFiles(data));
        } catch (e) {
            console.error('【出错信息】:' + e);
            fail(e);
        }
    });
};