define('cobble/form/Validator',['require','exports','module','../function/jquerify','../function/lifeCycle'],function(require){'use strict';function e(e){return r.init(this,e);}function t(e,t){if(e.length>0){var n=e[0].element;if(n.is(':hidden'))n=n.parent();var i=n.offset().top;if(t>0)i-=t;window.scrollTo(window.scrollX,i);}}function n(e){var t=$.Deferred();return $.when.apply($,e).done(function(){t.resolve(arguments);}),t;}var i=require('../function/jquerify'),r=require('../function/lifeCycle');e.prototype={constructor:e,type:'Validator',init:function(){var t=this,n=t.element,i='FORM'===n.prop('tagName')?n:n.find('form');if(i.length>0)i.attr('novalidate','novalidate').on('submit'+o,$.proxy(t.validate,t));$.each(t.fields,function(t,i){var r=n.find('[name="'+t+'"]'),o=i.type;if(!o)o=i.type=r.attr('type')||'text';var c=i.rules;if(!c)c=i.rules={};var u=e.type[o]||[];$.each(u,function(e,t){if(null==c[t]){var n=a[t];if($.isFunction(n))c[t]=n(r,i);}});});var r=t.groupSelector;if(n.on('focusin'+o,function(e){var n=$(e.target).closest(r),i=[t.successClass,t.errorClass,t.requiredClass].join(' ');n.removeClass($.trim(i));}),t.realtime)n.on('focusout'+o,function(e){var n=$(e.target),i=n.prop('name');if(!i)n=n.find('[name]'),i=n.prop('name');if(i)t.validate(i);});},validate:function(e,i){var r=this,a=r.emit('beforeValidate');if(!a.isDefaultPrevented()){var o,c=r.element,u=r.groupSelector;if('string'===$.type(e))e=[e];if($.isArray(e))o=$.map(e,function(e){return c.find('[name="'+e+'"]').closest(u);});else if(o=c.find(u),'boolean'===$.type(e))i=e;var l=[],s=[];$.each(o,function(e,t){var n=r.validateGroup($(t));if(n){if(n.promise)s.push(n),n=n.data;$.merge(l,n);}});var e=[],f=[],d=function(){if($.each(l,function(t,n){if(n.error)f.push(n);e.push(n.element.prop('name'));}),i)t(f,r.scrollGap);r.emit('afterValidate',{fields:e,errors:f});};if(s.length>0)return n(s).done(d);else return d(),0===f.length;}},validateGroup:function(t){if(t.is(':visible')){var i=this,r=[],a=[],o=[];if(t.find('[name]').each(function(t){var n,c,u=this,l=u.name,s=u.value,f=u.disabled,d=$(u);if(!f){var p=i.fields[l];if(p){n=!0,p=$.extend(!0,{},p),p.form=i.element,p.value=$.trim(s);var m;if($.each(e.type[p.type]||[],function(t,n){var i=e.rule[n](p);if(i===!1)return m=n,!1;else if(''===p.value&&'required'===n)return!1;}),m){var h=p.errors;if(h)c=h[m];if(!c)throw new Error(l+' 字段 '+m+' 类型错误信息未定义');}else if($.isFunction(p.custom)){var v=$.Deferred(),g=p.custom(d,function(e){v.resolve(e);});c=null==g||g.done?v:g;}}}if(n)if(t=r.push({element:d,error:c}),c&&c.promise)a.push(c),o.push(t-1);}),a.length>0){var c=n(a).done(function(e){$.each(e,function(e,t){r[o[e]].error=t;}),i.refreshGroup(t,r);});return c.data=r,c;}else return i.refreshGroup(t,r),r;}},refreshGroup:function(e,t){var n=this,i=n.successClass,r=n.errorClass;$.each(t,function(t,a){var o,c=a.element,u=a.error,l=n.errorSelector;if(l)o=e.find(l).eq(t);if(u&&'string'===$.type(u)){if(e.removeClass(i).addClass(r),o){var s=n.renderTemplate;if($.isFunction(s))u=s({text:u},n.errorTemplate);o.html(u).show();var f=n.errorPlacement;if($.isFunction(f))f(c,o);}}else if(a.error='',e.removeClass(r).addClass(i),o)o.html('').hide();});},dispose:function(){var e=this;r.dispose(e),e.element.off(o),e.element=null;}},i(e.prototype),e.defaultOptions={realtime:!1,scrollGap:100,groupSelector:'.form-group',successClass:'has-success',errorClass:'has-error',errorSelector:'.error',errorTemplate:'<i class="icon icon-times-circle"></i>&nbsp;${text}',requiredClass:'has-required',requiredSelector:'.required',requiredTemplate:'${text}',renderTemplate:function(e,t){return t.replace(/\${(\w+)}/g,function(t,n){return e[n]||'';});},errorPlacement:function(e,t){if('hidden'===e.prop('type'))e=e.parent();t.css({position:'static',width:'auto'});var n=t.outerWidth(!0)+5;t.css({position:'absolute',width:n});var i=e.parent();if(i.is('.placeholder-wrapper'))e=i;var r=e.position();t.css({left:r.left+e.outerWidth()-37,top:r.top-t.outerHeight()+8});}},e.type={text:['required','pattern','min','max','minlength','maxlength'],hidden:['required'],password:['required','pattern','minlength','maxlength','equals'],number:['required','pattern','min','max','step'],range:['required','pattern','min','max','step'],tel:['required','pattern'],url:['required','pattern'],email:['required','pattern'],mobile:['required','pattern'],money:['required','pattern','min','max'],idcard:['required','pattern'],'int':['required','pattern','min','max'],internationalMobile:['required','pattern']},e.rule={required:function(e){if(e.value.length>0)return!0;else if(e.rules.required)return!1;},pattern:function(e){var t=e.rules.pattern;if(t)return t.test(e.value);else return void 0;},minlength:function(e){var t=e.rules.minlength;if($.isNumeric(t))return e.value.length>=+t;else return void 0;},maxlength:function(e){var t=e.rules.maxlength;if($.isNumeric(t))return e.value.length<=+t;else return void 0;},min:function(e){var t=e.rules.min;if($.isNumeric(t))return e.value>=+t;else return void 0;},max:function(e){var t=e.rules.max;if($.isNumeric(t))return e.value<=+t;else return void 0;},step:function(e){var t=e.rules.step;if($.isNumeric(t)){var n=e.rules.min||1;return(e.value-n)%t===0;}},equals:function(e){var t=e.rules.equals;if(t){var n=e.form.find('[name="'+t+'"]');return e.value===$.trim(n.val());}}},e.pattern={number:/^[\d.]*$/,'int':/^\d+$/,url:/^(?:(?:0\d{2,3}[- ]?[1-9]\d{6,7})|(?:[48]00[- ]?[1-9]\d{6}))$/,tel:/^(?:(?:0\d{2,3}[- ]?[1-9]\d{6,7})|(?:[48]00[- ]?[1-9]\d{6}))$/,mobile:/^1[3-9]\d{9}$/,email:/^(?:[a-z0-9]+[_\-+.]+)*[a-z0-9]+@(?:([a-z0-9]+-?)*[a-z0-9]+.)+([a-z]{2,})+$/i,money:/^[\d.]*$/,idcard:/(^\d{15}$)|(^\d{17}([0-9]|X)$)/i,internationalMobile:/^\d{7,20}$/};var a={required:function(e){return'required'===e.attr('required');},pattern:function(t,n){var i=t.attr('pattern')||e.pattern[n.type];if('string'===$.type(i))i=new RegExp(i);return i;},minlength:function(e){return e.attr('minlength');},maxlength:function(e){return e.attr('maxlength');},min:function(e){return e.attr('min');},max:function(e){return e.attr('max');},step:function(e){return e.attr('step');},equals:function(e){return e.attr('equals');}},o='.cobble_form_validator';return e;}),define('cobble/function/jquerify',['require','exports','module'],function(){'use strict';function e(e){return e.faker||e.element;}var t=$.prototype,n={on:function(){return t.on.apply(e(this),arguments),this;},off:function(){return t.off.apply(e(this),arguments),this;},emit:function(n,i){var r=this,a=e(r);if(a){if(!n[$.expando])n='string'===$.type(n)?$.Event(n):$.Event(null,n);n.cobble=r;var o=[n];if(i)o.push(i);var c=r[$.camelCase('on-'+n.type)];if($.isFunction(c)&&c.apply(r,o)===!1)n.preventDefault();if(!n.isPropagationStopped())t.trigger.apply(a,o);return n;}},before:function(t){e(this).before(t);},after:function(t){e(this).after(t);},appendTo:function(t){e(this).appendTo(t);},prependTo:function(t){e(this).prependTo(t);}};return function(e){$.each(n,function(t,n){if(null==e[t])e[t]=n;});};}),define('cobble/function/lifeCycle',['require','exports'],function(require,exports){'use strict';exports.init=function(e,t){var n=e.constructor,i='__cobble__'+n.prototype.type,r=t.element;if(r&&r.data(i))e=r.data(i);else if($.extend(e,n.defaultOptions,t),e.init(),r)r.data(i,e);return e;},exports.dispose=function(e){var t='__cobble__'+e.constructor.prototype.type,n=e.element;if(n)n.removeData(t);};}),define('common/component/Captcha_e804b20fed',['require','cobble/form/Validator','common/service_9c322508d3'],function(require){'use strict';function e(e){$.extend(this,e),this.init();}function t(){var e=this;return{captcha:{errors:{required:'请输入验证码',minlength:'请输入 4 位验证码',maxlength:'请输入 4 位验证码'},custom:function(t,n){if(e.skipAuth)n();var r={captcha:e.newCaptcha,captcha_name:e.captchaName};if($.isFunction(e.onBeforeValidate))e.onBeforeValidate();i.validateCaptcha(r,{errorHandler:{1:function(){}}}).done(function(e){if(0===e.code)n();else n('请输入正确的验证码');});}}};}var n=require('cobble/form/Validator'),i=require('common/service_9c322508d3');return e.prototype={init:function(){var e=this,i=e.element,r=i.find('input[name="captcha"]');e.input=r,e.captchaImage=e.element.find('.captcha-image'),e.captchaName=e.captchaName||'',e.newCaptcha='',e.isValid=!1,e.needAuth=!0,e.captchaValidator=new n({element:i,fields:t.call(e),onAfterValidate:function(t,n){if(0===n.errors.length){if(e.needAuth=!1,e.isValid=!0,$.isFunction(e.onValid))e.onValid();}else if(e.isValid=!1,$.isFunction(e.onInvalid))e.onInvalid();}});var a,o=function(t){var n=$(t.currentTarget),i=$.trim(n.val()),r=/^[0-9a-zA-Z]{4}$/g;if(r.test(i))e.newCaptcha=i,e.captchaValidator.validate();};if(e.element.on('click','.btn-change-captcha',function(){e.change();}),!e.skipAuth)if(r.on('blur',function(t){var n=$(t.currentTarget);if(e.newCaptcha=n.val(),a!=e.newCaptcha||e.needAuth)if(!e.autoValidate)e.captchaValidator.validate();return a=n.val(),!1;}),e.autoValidate)r.on('input',o).on('propertychange',o);},validate:function(){return this.captchaValidator.validate(),this.isValid;},getValue:function(){return this.input.val();},change:function(){var e=this;if(e.captchaName)e.captchaImage.prop('src','/captcha?captcha_name='+e.captchaName+'&'+$.now());else e.captchaImage.prop('src','/captcha?'+$.now());if($.isFunction(e.onBeforeValidate))e.onBeforeValidate();e.needAuth=!0,e.input.val('');},hide:function(){this.element.hide(),this.hidden=!0;},show:function(){this.element.show(),this.hidden=!1;},setCaptchaName:function(e){this.captchaName=e||'';}},e;}),define('common/component/CodeButton_edf3c78096',['require'],function(){'use strict';function e(e){$.extend(this,e),this.init();}return e.prototype={init:function(){var e=this,t=e.element;e.isCounting=!1,e.origin=t.html();var n=function(){e.sendCode();};if(e.container)e.container.on('click',function(e){if(e.target===t[0])n();});else t.click(n);},countDown:function(e){var t=this,n=this.element;t.isCounting=!0;var i=function(e){if(n.html(e+' 秒后再次发送'),$.isFunction(t.onTextChange))t.onTextChange();};n.prop('disabled',!0),t.timer=setInterval(function(){if(e--,e>0)i(e);else t.reset();},1000),i(e);},reset:function(){var e=this;e.isCounting=!1;var t=e.element;if(clearInterval(e.timer),t.html(e.origin),t.prop('disabled',!1),$.isFunction(e.onTextChange))e.onTextChange();if($.isFunction(e.onFinish))e.onFinish();},dispose:function(){if(this.element.off(),this.timer)clearInterval(this.timer);},sendCode:function(){var e=this,t=e.element;t.prop('disabled',!0);var n=e.send();if(n)n.done(function(n){if(0===n.code)e.countDown(60);else t.prop('disabled',!1);});else t.prop('disabled',!1);return n;}},e;}),define('common/component/SaveButton_b1f301d041',['require'],function(){'use strict';function e(e){$.extend(this,e),this.init();}return e.prototype={init:function(){var e=this,t=e.element,n=t.html();if('BUTTON'!==t.prop('tagName'))throw new Error('SaveButton 必须使用 button 标签');var i=function(){var i=e.save();if(i)t.focus(),t.prop('disabled',!0),t.html(e.saveText||'正在保存...'),i.always(function(){setTimeout(function(){t.prop('disabled',!1),t.html(n);},10);});return!1;};if(t.click(i),e.form)e.form.submit(function(){return i(),!1;});}},e;}),define('org/common/report',['require','exports','common/component/CodeButton_edf3c78096','common/component/Captcha_e804b20fed','cobble/form/Validator','common/service_9c322508d3','common/store_a1a35b3dfc','common/component/SaveButton_b1f301d041'],function(require,exports){'use strict';function e(e,t){if(e.validate('mobile')&&!t.isCounting)t.element.prop('disabled',!1);else t.element.prop('disabled',!0);}function t(e){if(e===!0)return l.getSMSCode({mobile:$.trim(n.val()),captcha:i&&i.getValue()||'',captcha_name:'common',type:'voice'});if(!$.trim(n.val()))alert('请输入手机号');else{if(r='voice',i&&!i.hidden)if(!i.validate())return!1;alert({title:'获取语音校验码',content:'校验码将以电话形式通知到你\uFF0C请注意接听',buttons:[{text:'获取',type:'primary',handler:function(){this.hide(),l.getSMSCode({mobile:$.trim(n.val()),captcha:i&&i.getValue()||'',captcha_name:'common',type:'voice'},{errorHandler:{1000111:function(){i.show(),i.change(),setTimeout(function(){i.validate();});}}});}},{text:'取消',handler:function(){this.hide();}}]});}}var n,i,r,a,o=require('common/component/CodeButton_edf3c78096'),c=require('common/component/Captcha_e804b20fed'),u=require('cobble/form/Validator'),l=require('common/service_9c322508d3'),s=require('common/store_a1a35b3dfc'),f=require('common/component/SaveButton_b1f301d041'),d=$('#report'),p='<div class="form-block captcha form-captcha"><div class="form-group"><label class="form-label">验证码</label><div class="form-controls"><span class="input-group"><input class="form-text" type="text" name="captcha" required minlength="4" maxlength="4" placeholder="请输入图中的数字"><span class="input-group-addon"><img class="captcha-image" src="/captcha?captcha_name=exceed_count&'+$.now()+'" /></span></span><span class="error"></span></div><div class="form-hint"><span class="btn-link btn-change-captcha">换一张</span></div></div></div>',m=d.find('.report_detail'),h=m.find('label'),v=h.length;if(3==v)a='50px';else a='35px';h.each(function(){h.css('line-height',a);}),exports.init=function(){var a=d.find('.voice-code-link');a.on('click','.btn-link',t);{var m=new u({realtime:!0,element:d.find('.check_box'),fields:{username:{errors:{required:'请输入姓名',pattern:'请输入正确的姓名',maxlength:'输入有误'}},mobile:{errors:{required:'请输入手机号',pattern:'请输入正确的手机号'}},verifycode:{errors:{required:'请输入校验码',pattern:'请输入正确的校验码'}}}}),h=d.find('.form-sms'),v=h.find('.sms'),g=h.find('.form-get-smscode');v.width();}n=d.find('input[type="mobile"]');var b,g=d.find('.form-get-smscode');b=new o({element:g,send:function(){var e=$.trim(n.val()),a='common';return r='sms',l.getSMSCode({mobile:e,type:a,captcha:i&&i.getValue()||''},{errorHandler:{1000111:function(){if(!i)$(p.replace('exceed_count',a)).insertBefore('.form-group.form-sms'),i=new c({element:d.find('.form-block.captcha'),captchaName:a,skipAuth:!1,autoValidate:!0,onValid:function(){if(i.hide(),!r||'sms'===r)g.prop('disabled',!1),b.sendCode();else t(!0);v.focus(),setTimeout(function(){i.input.val('');});},onInvalid:function(){g.prop('disabled',!0);}});else i.change();i.show(),setTimeout(function(){i.validate();},0);}}}).done(function(e){if(0==e.code)v.focus();});},onTextChange:function(){}});var y=d.find('.check_box');d.on('click','#nowreport',function(){y.show();}).on('blur','input[type="mobile"]',function(){e(m,b);}).on('click','.back',function(){y.hide();}),new f({element:d.find('.sure'),save:function(){var e=!0;if(d.find('.agile').each(function(t,n){var i=$(n).find('input'),r=i.val(),a=$(n).find('.form-label').text(),o=i.attr('required');if(o&&''==r)e=!1,alert(a+'不能为空');if(r.length>100)e=!1,alert('请将'+a+'字数控制在50字以内');}),m.validate()&&e){var t=d.find("input[name='username']").val(),n=d.find("input[name='mobile']").val(),i={};i.name=t,i.mobile=n,d.find('.agile').each(function(e,t){var n=$(t).find('input'),r=n.val(),a=n.attr('name');i[a]=r;});var r=d.find("input[name='verifycode']").val();l.createReport({signInfo:i,board_id:s.get('blackBoradId'),smscode:r}).done(function(e){if(0===e.code){{e.data;}alert({content:'恭喜您\uFF0C报名成功<i class="icon icon-check-o"></i>'}),y.hide();var t=d.find('.succ'),n=d.find('.old');n.hide(),t.show();}});}}});};});