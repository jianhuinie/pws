define('cobble/form/Validator',['require','exports','module','../function/jquerify','../function/lifeCycle'],function(require){'use strict';function e(e){return i.init(this,e);}function n(e,n){if(e.length>0){var t=e[0].element;if(t.is(':hidden'))t=t.parent();var r=t.offset().top;if(n>0)r-=n;window.scrollTo(window.scrollX,r);}}function t(e){var n=$.Deferred();return $.when.apply($,e).done(function(){n.resolve(arguments);}),n;}var r=require('../function/jquerify'),i=require('../function/lifeCycle');e.prototype={constructor:e,type:'Validator',init:function(){var n=this,t=n.element,r='FORM'===t.prop('tagName')?t:t.find('form');if(r.length>0)r.attr('novalidate','novalidate').on('submit'+a,$.proxy(n.validate,n));$.each(n.fields,function(n,r){var i=t.find('[name="'+n+'"]'),a=r.type;if(!a)a=r.type=i.attr('type')||'text';var u=r.rules;if(!u)u=r.rules={};var s=e.type[a]||[];$.each(s,function(e,n){if(null==u[n]){var t=o[n];if($.isFunction(t))u[n]=t(i,r);}});});var i=n.groupSelector;if(t.on('focusin'+a,function(e){var t=$(e.target).closest(i),r=[n.successClass,n.errorClass,n.requiredClass].join(' ');t.removeClass($.trim(r));}),n.realtime)t.on('focusout'+a,function(e){var t=$(e.target),r=t.prop('name');if(!r)t=t.find('[name]'),r=t.prop('name');if(r)n.validate(r);});},validate:function(e,r){var i=this,o=i.emit('beforeValidate');if(!o.isDefaultPrevented()){var a,u=i.element,s=i.groupSelector;if('string'===$.type(e))e=[e];if($.isArray(e))a=$.map(e,function(e){return u.find('[name="'+e+'"]').closest(s);});else if(a=u.find(s),'boolean'===$.type(e))r=e;var l=[],f=[];$.each(a,function(e,n){var t=i.validateGroup($(n));if(t){if(t.promise)f.push(t),t=t.data;$.merge(l,t);}});var e=[],c=[],d=function(){if($.each(l,function(n,t){if(t.error)c.push(t);e.push(t.element.prop('name'));}),r)n(c,i.scrollGap);i.emit('afterValidate',{fields:e,errors:c});};if(f.length>0)return t(f).done(d);else return d(),0===c.length;}},validateGroup:function(n){if(n.is(':visible')){var r=this,i=[],o=[],a=[];if(n.find('[name]').each(function(n){var t,u,s=this,l=s.name,f=s.value,c=s.disabled,d=$(s);if(!c){var m=r.fields[l];if(m){t=!0,m=$.extend(!0,{},m),m.form=r.element,m.value=$.trim(f);var p;if($.each(e.type[m.type]||[],function(n,t){var r=e.rule[t](m);if(r===!1)return p=t,!1;else if(''===m.value&&'required'===t)return!1;}),p){var v=m.errors;if(v)u=v[p];if(!u)throw new Error(l+' 字段 '+p+' 类型错误信息未定义');}else if($.isFunction(m.custom)){var h=$.Deferred(),g=m.custom(d,function(e){h.resolve(e);});u=null==g||g.done?h:g;}}}if(t)if(n=i.push({element:d,error:u}),u&&u.promise)o.push(u),a.push(n-1);}),o.length>0){var u=t(o).done(function(e){$.each(e,function(e,n){i[a[e]].error=n;}),r.refreshGroup(n,i);});return u.data=i,u;}else return r.refreshGroup(n,i),i;}},refreshGroup:function(e,n){var t=this,r=t.successClass,i=t.errorClass;$.each(n,function(n,o){var a,u=o.element,s=o.error,l=t.errorSelector;if(l)a=e.find(l).eq(n);if(s&&'string'===$.type(s)){if(e.removeClass(r).addClass(i),a){var f=t.renderTemplate;if($.isFunction(f))s=f({text:s},t.errorTemplate);a.html(s).show();var c=t.errorPlacement;if($.isFunction(c))c(u,a);}}else if(o.error='',e.removeClass(i).addClass(r),a)a.html('').hide();});},dispose:function(){var e=this;i.dispose(e),e.element.off(a),e.element=null;}},r(e.prototype),e.defaultOptions={realtime:!1,scrollGap:100,groupSelector:'.form-group',successClass:'has-success',errorClass:'has-error',errorSelector:'.error',errorTemplate:'<i class="icon icon-times-circle"></i>&nbsp;${text}',requiredClass:'has-required',requiredSelector:'.required',requiredTemplate:'${text}',renderTemplate:function(e,n){return n.replace(/\${(\w+)}/g,function(n,t){return e[t]||'';});},errorPlacement:function(e,n){if('hidden'===e.prop('type'))e=e.parent();n.css({position:'static',width:'auto'});var t=n.outerWidth(!0)+5;n.css({position:'absolute',width:t});var r=e.parent();if(r.is('.placeholder-wrapper'))e=r;var i=e.position();n.css({left:i.left+e.outerWidth()-37,top:i.top-n.outerHeight()+8});}},e.type={text:['required','pattern','min','max','minlength','maxlength'],hidden:['required'],password:['required','pattern','minlength','maxlength','equals'],number:['required','pattern','min','max','step'],range:['required','pattern','min','max','step'],tel:['required','pattern'],url:['required','pattern'],email:['required','pattern'],mobile:['required','pattern'],money:['required','pattern','min','max'],idcard:['required','pattern'],'int':['required','pattern','min','max'],internationalMobile:['required','pattern']},e.rule={required:function(e){if(e.value.length>0)return!0;else if(e.rules.required)return!1;},pattern:function(e){var n=e.rules.pattern;if(n)return n.test(e.value);else return void 0;},minlength:function(e){var n=e.rules.minlength;if($.isNumeric(n))return e.value.length>=+n;else return void 0;},maxlength:function(e){var n=e.rules.maxlength;if($.isNumeric(n))return e.value.length<=+n;else return void 0;},min:function(e){var n=e.rules.min;if($.isNumeric(n))return e.value>=+n;else return void 0;},max:function(e){var n=e.rules.max;if($.isNumeric(n))return e.value<=+n;else return void 0;},step:function(e){var n=e.rules.step;if($.isNumeric(n)){var t=e.rules.min||1;return(e.value-t)%n===0;}},equals:function(e){var n=e.rules.equals;if(n){var t=e.form.find('[name="'+n+'"]');return e.value===$.trim(t.val());}}},e.pattern={number:/^[\d.]*$/,'int':/^\d+$/,url:/^(?:(?:0\d{2,3}[- ]?[1-9]\d{6,7})|(?:[48]00[- ]?[1-9]\d{6}))$/,tel:/^(?:(?:0\d{2,3}[- ]?[1-9]\d{6,7})|(?:[48]00[- ]?[1-9]\d{6}))$/,mobile:/^1[3-9]\d{9}$/,email:/^(?:[a-z0-9]+[_\-+.]+)*[a-z0-9]+@(?:([a-z0-9]+-?)*[a-z0-9]+.)+([a-z]{2,})+$/i,money:/^[\d.]*$/,idcard:/(^\d{15}$)|(^\d{17}([0-9]|X)$)/i,internationalMobile:/^\d{7,20}$/};var o={required:function(e){return'required'===e.attr('required');},pattern:function(n,t){var r=n.attr('pattern')||e.pattern[t.type];if('string'===$.type(r))r=new RegExp(r);return r;},minlength:function(e){return e.attr('minlength');},maxlength:function(e){return e.attr('maxlength');},min:function(e){return e.attr('min');},max:function(e){return e.attr('max');},step:function(e){return e.attr('step');},equals:function(e){return e.attr('equals');}},a='.cobble_form_validator';return e;}),define('cobble/function/jquerify',['require','exports','module'],function(){'use strict';function e(e){return e.faker||e.element;}var n=$.prototype,t={on:function(){return n.on.apply(e(this),arguments),this;},off:function(){return n.off.apply(e(this),arguments),this;},emit:function(t,r){var i=this,o=e(i);if(o){if(!t[$.expando])t='string'===$.type(t)?$.Event(t):$.Event(null,t);t.cobble=i;var a=[t];if(r)a.push(r);var u=i[$.camelCase('on-'+t.type)];if($.isFunction(u)&&u.apply(i,a)===!1)t.preventDefault();if(!t.isPropagationStopped())n.trigger.apply(o,a);return t;}},before:function(n){e(this).before(n);},after:function(n){e(this).after(n);},appendTo:function(n){e(this).appendTo(n);},prependTo:function(n){e(this).prependTo(n);}};return function(e){$.each(t,function(n,t){if(null==e[n])e[n]=t;});};}),define('cobble/function/lifeCycle',['require','exports'],function(require,exports){'use strict';exports.init=function(e,n){var t=e.constructor,r='__cobble__'+t.prototype.type,i=n.element;if(i&&i.data(r))e=i.data(r);else if($.extend(e,t.defaultOptions,n),e.init(),i)i.data(r,e);return e;},exports.dispose=function(e){var n='__cobble__'+e.constructor.prototype.type,t=e.element;if(t)t.removeData(n);};}),define('common/center/account/email_598856f569',['require','exports','cobble/form/Validator','common/component/CodeButton_edf3c78096','common/component/SaveButton_b1f301d041','common/service_9c322508d3'],function(require,exports){'use strict';var e=require('cobble/form/Validator'),n=require('common/component/CodeButton_edf3c78096'),t=require('common/component/SaveButton_b1f301d041'),r=require('common/service_9c322508d3'),i={new_email:{errors:{required:'请输入邮箱地址',pattern:'请输入正确的邮箱'}},password:{errors:{required:'请输入登陆密码',minlength:'请输入6-20位密码',maxlength:'请输入6-20位密码'}},verify_code:{errors:{required:'请输入邮箱验证码'}}},o={password:{errors:{required:'请输入登陆密码',minlength:'请输入6-20位密码',maxlength:'请输入6-20位密码'}},new_email:{errors:{required:'请输入新邮箱地址',pattern:'请输入正确的邮箱'}},verify_code:{errors:{required:'请输入邮箱验证码'}}};exports.init=function(){var a=$('#content .item-email'),u=a.find('#form-email'),s=new e({element:u,fields:i}),l=new e({element:u,fields:o}),f=(new n({element:a.find('#email-send'),send:function(){var e='new_email';if(s.validate(e)){var n=u.find('[name="'+e+'"]').val();if(n)r.checkEmailAuth({email:n}).done(function(e){if(0===e.code)r.sendEmailCode({email:n}).done(function(e){if(0===e.code)success('校验码发送成功\uFF0C请注意查收');});else alert('该邮箱已存在\uFF0C请更换新邮箱');});else{var t=u.find('[name="email"]').val();r.sendEmailCode({email:t}).done(function(e){if(0===e.code)success('校验码发送成功\uFF0C请注意查收');});}}}}),a.find('#email-submit'));if(0!=f.length){new t({element:f,save:function(){{var e=this.element,n=e.closest('form'),t=e.closest('.item-body'),i=(t.prev('.item-header'),n.find('input[name="new_email"]').val()),o=i.indexOf('@')-2;i.substr(0,2)+'*****'+i.substr(o);}if(s.validate()){var a=u.find('input[name="new_email"]').val(),l=u.find('input[name="password"]').val(),f=u.find('input[name="verify_code"]').val();if(''==a)a=u.find('input[name="email"]').val();return r.saveNewemail({new_email:a,password:l,verify_code:f}).done(function(e){if(0===e.code)success('邮箱绑定成功',function(){location.reload();});});}}});}var c=a.find('#newemail-submit');if(0!=c.length){new t({element:c,save:function(){{var e=this.element,n=e.closest('form'),t=e.closest('.item-body'),i=(t.prev('.item-header'),n.find('input[name="new_email"]').val()),o=i.indexOf('@')-2;i.substr(0,2)+'*****'+i.substr(o);}if(l.validate()){var a=u.find('input[name="password"]').val(),s=u.find('input[name="new_email"]').val(),f=u.find('input[name="verify_code"]').val();if(''==s)s=u.find('input[name="email"]').val();return r.saveEmail({password:a,new_email:s,verify_code:f}).done(function(e){if(0===e.code)success('邮箱绑定成功',function(){location.reload();});});}}});}a.on('click','.btn-edit',function(e){var n=$(e.currentTarget),t=n.closest('.item');t.find('.form-result').hide(),t.find('.form').show();}).on('click','.to-new-email',function(e){var n=$(e.currentTarget),t=n.closest('.form-group'),r=a.find('.new-email-group');t.hide(),r.show();});};}),define('common/component/CodeButton_edf3c78096',['require'],function(){'use strict';function e(e){$.extend(this,e),this.init();}return e.prototype={init:function(){var e=this,n=e.element;e.isCounting=!1,e.origin=n.html();var t=function(){e.sendCode();};if(e.container)e.container.on('click',function(e){if(e.target===n[0])t();});else n.click(t);},countDown:function(e){var n=this,t=this.element;n.isCounting=!0;var r=function(e){if(t.html(e+' 秒后再次发送'),$.isFunction(n.onTextChange))n.onTextChange();};t.prop('disabled',!0),n.timer=setInterval(function(){if(e--,e>0)r(e);else n.reset();},1000),r(e);},reset:function(){var e=this;e.isCounting=!1;var n=e.element;if(clearInterval(e.timer),n.html(e.origin),n.prop('disabled',!1),$.isFunction(e.onTextChange))e.onTextChange();if($.isFunction(e.onFinish))e.onFinish();},dispose:function(){if(this.element.off(),this.timer)clearInterval(this.timer);},sendCode:function(){var e=this,n=e.element;n.prop('disabled',!0);var t=e.send();if(t)t.done(function(t){if(0===t.code)e.countDown(60);else n.prop('disabled',!1);});else n.prop('disabled',!1);return t;}},e;}),define('common/component/SaveButton_b1f301d041',['require'],function(){'use strict';function e(e){$.extend(this,e),this.init();}return e.prototype={init:function(){var e=this,n=e.element,t=n.html();if('BUTTON'!==n.prop('tagName'))throw new Error('SaveButton 必须使用 button 标签');var r=function(){var r=e.save();if(r)n.focus(),n.prop('disabled',!0),n.html(e.saveText||'正在保存...'),r.always(function(){setTimeout(function(){n.prop('disabled',!1),n.html(t);},10);});return!1;};if(n.click(r),e.form)e.form.submit(function(){return r(),!1;});}},e;});