define("cobble/form/Validator",["require","exports","module","../function/jquerify","../function/lifeCycle"],function(require){"use strict";function e(e){return i.init(this,e)}function r(e,r){if(e.length>0){var t=e[0].element;if(t.is(":hidden"))t=t.parent();var n=t.offset().top;if(r>0)n-=r;window.scrollTo(window.scrollX,n)}}function t(e){var r=$.Deferred();return $.when.apply($,e).done(function(){r.resolve(arguments)}),r}var n=require("../function/jquerify"),i=require("../function/lifeCycle");e.prototype={constructor:e,type:"Validator",init:function(){var r=this,t=r.element,n="FORM"===t.prop("tagName")?t:t.find("form");if(n.length>0)n.attr("novalidate","novalidate").on("submit"+o,$.proxy(r.validate,r));$.each(r.fields,function(r,n){var i=t.find('[name="'+r+'"]'),o=n.type;if(!o)o=n.type=i.attr("type")||"text";var u=n.rules;if(!u)u=n.rules={};var s=e.type[o]||[];$.each(s,function(e,r){if(null==u[r]){var t=a[r];if($.isFunction(t))u[r]=t(i,n)}})});var i=r.groupSelector;if(t.on("focusin"+o,function(e){var t=$(e.target).closest(i),n=[r.successClass,r.errorClass,r.requiredClass].join(" ");t.removeClass($.trim(n))}),r.realtime)t.on("focusout"+o,function(e){var t=$(e.target),n=t.prop("name");if(!n)t=t.find("[name]"),n=t.prop("name");if(n)r.validate(n)})},validate:function(e,n){var i=this,a=i.emit("beforeValidate");if(!a.isDefaultPrevented()){var o,u=i.element,s=i.groupSelector;if("string"===$.type(e))e=[e];if($.isArray(e))o=$.map(e,function(e){return u.find('[name="'+e+'"]').closest(s)});else if(o=u.find(s),"boolean"===$.type(e))n=e;var l=[],f=[];$.each(o,function(e,r){var t=i.validateGroup($(r));if(t){if(t.promise)f.push(t),t=t.data;$.merge(l,t)}});var e=[],c=[],p=function(){if($.each(l,function(r,t){if(t.error)c.push(t);e.push(t.element.prop("name"))}),n)r(c,i.scrollGap);i.emit("afterValidate",{fields:e,errors:c})};if(f.length>0)return t(f).done(p);else return p(),0===c.length}},validateGroup:function(r){if(r.is(":visible")){var n=this,i=[],a=[],o=[];if(r.find("[name]").each(function(r){var t,u,s=this,l=s.name,f=s.value,c=s.disabled,p=$(s);if(!c){var d=n.fields[l];if(d){t=!0,d=$.extend(!0,{},d),d.form=n.element,d.value=$.trim(f);var m;if($.each(e.type[d.type]||[],function(r,t){var n=e.rule[t](d);if(n===!1)return m=t,!1;else if(""===d.value&&"required"===t)return!1}),m){var v=d.errors;if(v)u=v[m];if(!u)throw new Error(l+" 字段 "+m+" 类型错误信息未定义")}else if($.isFunction(d.custom)){var h=$.Deferred(),y=d.custom(p,function(e){h.resolve(e)});u=null==y||y.done?h:y}}}if(t)if(r=i.push({element:p,error:u}),u&&u.promise)a.push(u),o.push(r-1)}),a.length>0){var u=t(a).done(function(e){$.each(e,function(e,r){i[o[e]].error=r}),n.refreshGroup(r,i)});return u.data=i,u}else return n.refreshGroup(r,i),i}},refreshGroup:function(e,r){var t=this,n=t.successClass,i=t.errorClass;$.each(r,function(r,a){var o,u=a.element,s=a.error,l=t.errorSelector;if(l)o=e.find(l).eq(r);if(s&&"string"===$.type(s)){if(e.removeClass(n).addClass(i),o){var f=t.renderTemplate;if($.isFunction(f))s=f({text:s},t.errorTemplate);o.html(s).show();var c=t.errorPlacement;if($.isFunction(c))c(u,o)}}else if(a.error="",e.removeClass(i).addClass(n),o)o.html("").hide()})},dispose:function(){var e=this;i.dispose(e),e.element.off(o),e.element=null}},n(e.prototype),e.defaultOptions={realtime:!1,scrollGap:100,groupSelector:".form-group",successClass:"has-success",errorClass:"has-error",errorSelector:".error",errorTemplate:'<i class="icon icon-times-circle"></i>&nbsp;${text}',requiredClass:"has-required",requiredSelector:".required",requiredTemplate:"${text}",renderTemplate:function(e,r){return r.replace(/\${(\w+)}/g,function(r,t){return e[t]||""})},errorPlacement:function(e,r){if("hidden"===e.prop("type"))e=e.parent();r.css({position:"static",width:"auto"});var t=r.outerWidth(!0)+5;r.css({position:"absolute",width:t});var n=e.parent();if(n.is(".placeholder-wrapper"))e=n;var i=e.position();r.css({left:i.left+e.outerWidth()-37,top:i.top-r.outerHeight()+8})}},e.type={text:["required","pattern","min","max","minlength","maxlength"],hidden:["required"],password:["required","pattern","minlength","maxlength","equals"],number:["required","pattern","min","max","step"],range:["required","pattern","min","max","step"],tel:["required","pattern"],url:["required","pattern"],email:["required","pattern"],mobile:["required","pattern"],money:["required","pattern","min","max"],idcard:["required","pattern"],"int":["required","pattern","min","max"],internationalMobile:["required","pattern"]},e.rule={required:function(e){if(e.value.length>0)return!0;else if(e.rules.required)return!1},pattern:function(e){var r=e.rules.pattern;if(r)return r.test(e.value);else return void 0},minlength:function(e){var r=e.rules.minlength;if($.isNumeric(r))return e.value.length>=+r;else return void 0},maxlength:function(e){var r=e.rules.maxlength;if($.isNumeric(r))return e.value.length<=+r;else return void 0},min:function(e){var r=e.rules.min;if($.isNumeric(r))return e.value>=+r;else return void 0},max:function(e){var r=e.rules.max;if($.isNumeric(r))return e.value<=+r;else return void 0},step:function(e){var r=e.rules.step;if($.isNumeric(r)){var t=e.rules.min||1;return(e.value-t)%r===0}},equals:function(e){var r=e.rules.equals;if(r){var t=e.form.find('[name="'+r+'"]');return e.value===$.trim(t.val())}}},e.pattern={number:/^[\d.]*$/,"int":/^\d+$/,url:/^(?:(?:0\d{2,3}[- ]?[1-9]\d{6,7})|(?:[48]00[- ]?[1-9]\d{6}))$/,tel:/^(?:(?:0\d{2,3}[- ]?[1-9]\d{6,7})|(?:[48]00[- ]?[1-9]\d{6}))$/,mobile:/^1[3-9]\d{9}$/,email:/^(?:[a-z0-9]+[_\-+.]+)*[a-z0-9]+@(?:([a-z0-9]+-?)*[a-z0-9]+.)+([a-z]{2,})+$/i,money:/^[\d.]*$/,idcard:/(^\d{15}$)|(^\d{17}([0-9]|X)$)/i,internationalMobile:/^\d{7,20}$/};var a={required:function(e){return"required"===e.attr("required")},pattern:function(r,t){var n=r.attr("pattern")||e.pattern[t.type];if("string"===$.type(n))n=new RegExp(n);return n},minlength:function(e){return e.attr("minlength")},maxlength:function(e){return e.attr("maxlength")},min:function(e){return e.attr("min")},max:function(e){return e.attr("max")},step:function(e){return e.attr("step")},equals:function(e){return e.attr("equals")}},o=".cobble_form_validator";return e}),define("cobble/function/jquerify",["require","exports","module"],function(){"use strict";function e(e){return e.faker||e.element}var r=$.prototype,t={on:function(){return r.on.apply(e(this),arguments),this},off:function(){return r.off.apply(e(this),arguments),this},emit:function(t,n){var i=this,a=e(i);if(a){if(!t[$.expando])t="string"===$.type(t)?$.Event(t):$.Event(null,t);t.cobble=i;var o=[t];if(n)o.push(n);var u=i[$.camelCase("on-"+t.type)];if($.isFunction(u)&&u.apply(i,o)===!1)t.preventDefault();if(!t.isPropagationStopped())r.trigger.apply(a,o);return t}},before:function(r){e(this).before(r)},after:function(r){e(this).after(r)},appendTo:function(r){e(this).appendTo(r)},prependTo:function(r){e(this).prependTo(r)}};return function(e){$.each(t,function(r,t){if(null==e[r])e[r]=t})}}),define("cobble/function/lifeCycle",["require","exports"],function(require,exports){"use strict";exports.init=function(e,r){var t=e.constructor,n="__cobble__"+t.prototype.type,i=r.element;if(i&&i.data(n))e=i.data(n);else if($.extend(e,t.defaultOptions,r),e.init(),i)i.data(n,e);return e},exports.dispose=function(e){var r="__cobble__"+e.constructor.prototype.type,t=e.element;if(t)t.removeData(r)}}),define("common/form",["require","exports","cobble/form/Validator"],function(require,exports){"use strict";function e(e){var r={},t=e.find("[name]");return t.each(function(){var e=this.name,t=this.value,n="radio"===this.type||"checkbox"===this.type;if(n){if(this.checked)r[e]=t}else{var i=r[e];if(null==i)r[e]=t;else i=r[e]=[i],i.push(t)}}),$.each(r,function(e,t){r[e]=$.isArray(t)?t.join(","):$.trim(t)}),r}function r(e,r){$.each(r,function(r,n){if(n){var i=e.find('[name="'+r+'"]'),a=i.closest(".form-group");a.removeClass("has-success").addClass("has-error");var o=a.find(".error");o.html(n),t.defaultOptions.errorPlacement(i,o)}})}var t=require("cobble/form/Validator");exports.parse=function(r){return e(r)},exports.get=function(t,n){return $.ajax({url:n,type:"get",dataType:"json",data:t.jquery?e(t):t}).done(function(e){if(e.code){var n=e.data;if(n)r(t,n)}return e})},exports.post=function(t,n){return $.ajax({url:n,type:"post",dataType:"json",data:t.jquery?e(t):t}).done(function(e){if(e.code){var n=e.data;if(n)r(t,n)}return e})}});