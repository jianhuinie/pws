define("echarts/chart/funnel",["require","../component/base","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","../config","../util/ecData","../util/number","zrender/tool/util","zrender/tool/color","zrender/tool/area","../chart"],function(require){function e(e,n,s,l,r){t.call(this,e,n,s,l,r),i.call(this),this.refresh(l)}var t=require("../component/base"),i=require("./base"),n=require("zrender/shape/Text"),s=require("zrender/shape/Line"),l=require("zrender/shape/Polygon"),r=require("../config"),a=require("../util/ecData"),o=require("../util/number"),h=require("zrender/tool/util"),c=require("zrender/tool/color"),p=require("zrender/tool/area");return e.prototype={type:r.CHART_TYPE_FUNNEL,_buildShape:function(){var e=this.series,t=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var i,n=0,s=e.length;s>n;n++)if(e[n].type===r.CHART_TYPE_FUNNEL){if(e[n]=this.reformOption(e[n]),this.legendHoverLink=e[n].legendHoverLink||this.legendHoverLink,i=e[n].name||"",this.selectedMap[i]=t?t.isSelected(i):!0,!this.selectedMap[i])continue;this._buildSingleFunnel(n),this.buildMark(n)}this.addShapeList()},_buildSingleFunnel:function(e){var t=this.component.legend,i=this.series[e],n=this._mapData(e),s=this._getLocation(e);this._paramsMap[e]={location:s,data:n};for(var l,r=0,a=[],h=0,c=n.length;c>h;h++){if(l=n[h].name,t)this.selectedMap[l]=t.isSelected(l);else this.selectedMap[l]=!0;if(this.selectedMap[l]&&!isNaN(n[h].value))a.push(n[h]),r++}if(0!==r){for(var p,d,u,g,f=this._buildFunnelCase(e),b=i.funnelAlign,m=i.gap,y=r>1?(s.height-(r-1)*m)/r:s.height,L=s.y,v="descending"===i.sort?this._getItemWidth(e,a[0].value):o.parsePercent(i.minSize,s.width),x="descending"===i.sort?1:0,_=s.centerX,S=[],h=0,c=a.length;c>h;h++)if(l=a[h].name,this.selectedMap[l]&&!isNaN(a[h].value)){switch(p=c-2>=h?this._getItemWidth(e,a[h+x].value):"descending"===i.sort?o.parsePercent(i.minSize,s.width):o.parsePercent(i.maxSize,s.width),b){case"left":d=s.x;break;case"right":d=s.x+s.width-v;break;default:d=_-v/2}if(u=this._buildItem(e,a[h]._index,t?t.getColor(l):this.zr.getColor(a[h]._index),d,L,v,p,y,b),L+=y+m,g=u.style.pointList,S.unshift([g[0][0]-10,g[0][1]]),S.push([g[1][0]+10,g[1][1]]),0===h)if(0===v){if(g=S.pop(),"center"==b&&(S[0][0]+=10),"right"==b&&(S[0][0]=g[0]),S[0][1]-="center"==b?10:15,1==c)g=u.style.pointList}else S[S.length-1][1]-=5,S[0][1]-=5;v=p}if(f){if(S.unshift([g[3][0]-10,g[3][1]]),S.push([g[2][0]+10,g[2][1]]),0===v)g=S.pop(),"center"==b&&(S[0][0]+=10),"right"==b&&(S[0][0]=g[0]),S[0][1]+="center"==b?10:15;else S[S.length-1][1]+=5,S[0][1]+=5;f.style.pointList=S}}},_buildFunnelCase:function(e){var t=this.series[e];if(this.deepQuery([t,this.option],"calculable")){var i=this._paramsMap[e].location,n=10,s={hoverable:!1,style:{pointListd:[[i.x-n,i.y-n],[i.x+i.width+n,i.y-n],[i.x+i.width+n,i.y+i.height+n],[i.x-n,i.y+i.height+n]],brushType:"stroke",lineWidth:1,strokeColor:t.calculableHolderColor||this.ecTheme.calculableHolderColor}};return a.pack(s,t,e,void 0,-1),this.setCalculable(s),s=new l(s),this.shapeList.push(s),s}},_getLocation:function(e){var t,i=this.series[e],n=this.zr.getWidth(),s=this.zr.getHeight(),l=this.parsePercent(i.x,n),r=this.parsePercent(i.y,s);if(null==i.width)t=n-l-this.parsePercent(i.x2,n);else t=this.parsePercent(i.width,n);var a;if(null==i.height)a=s-r-this.parsePercent(i.y2,s);else a=this.parsePercent(i.height,s);return{x:l,y:r,width:t,height:a,centerX:l+t/2}},_mapData:function(e){function t(e,t){if("-"===e.value)return 1;else if("-"===t.value)return-1;return t.value-e.value}function i(e,i){return-t(e,i)}for(var n=this.series[e],s=h.clone(n.data),l=0,r=s.length;r>l;l++)s[l]._index=l;if("none"!=n.sort)s.sort("descending"===n.sort?t:i);return s},_buildItem:function(e,t,i,n,s,l,r,o,h){var c=this.series,p=c[e],d=p.data[t],u=this.getPolygon(e,t,i,n,s,l,r,o,h);a.pack(u,c[e],e,c[e].data[t],t,c[e].data[t].name),this.shapeList.push(u);var g=this.getLabel(e,t,i,n,s,l,r,o,h);if(a.pack(g,c[e],e,c[e].data[t],t,c[e].data[t].name),this.shapeList.push(g),!this._needLabel(p,d,!1))g.invisible=!0;var f=this.getLabelLine(e,t,i,n,s,l,r,o,h);if(this.shapeList.push(f),!this._needLabelLine(p,d,!1))f.invisible=!0;var b=[],m=[];if(this._needLabelLine(p,d,!0))b.push(f.id),m.push(f.id);if(this._needLabel(p,d,!0))b.push(g.id),m.push(u.id);return u.hoverConnect=b,g.hoverConnect=m,u},_getItemWidth:function(e,t){var i=this.series[e],n=this._paramsMap[e].location,s=i.min,l=i.max,r=o.parsePercent(i.minSize,n.width),a=o.parsePercent(i.maxSize,n.width);return t*(a-r)/(l-s)},getPolygon:function(e,t,i,n,s,r,a,o,h){var p,d=this.series[e],u=d.data[t],g=[u,d],f=this.deepMerge(g,"itemStyle.normal")||{},b=this.deepMerge(g,"itemStyle.emphasis")||{},m=this.getItemStyleColor(f.color,e,t,u)||i,y=this.getItemStyleColor(b.color,e,t,u)||("string"==typeof m?c.lift(m,-.2):m);switch(h){case"left":p=n;break;case"right":p=n+(r-a);break;default:p=n+(r-a)/2}var L={zlevel:this._zlevelBase,clickable:this.deepQuery(g,"clickable"),style:{pointList:[[n,s],[n+r,s],[p+a,s+o],[p,s+o]],brushType:"both",color:m,lineWidth:f.borderWidth,strokeColor:f.borderColor},highlightStyle:{color:y,lineWidth:b.borderWidth,strokeColor:b.borderColor}};if(this.deepQuery([u,d,this.option],"calculable"))this.setCalculable(L),L.draggable=!0;return new l(L)},getLabel:function(e,t,i,s,l,r,a,o,d){var u,g=this.series[e],f=g.data[t],b=this._paramsMap[e].location,m=h.merge(h.clone(f.itemStyle)||{},g.itemStyle),y="normal",L=m[y].label,v=L.textStyle||{},x=m[y].labelLine.length,_=this.getLabelText(e,t,y),S=this.getFont(v),z=i;if(L.position=L.position||m.normal.label.position,"inner"===L.position||"inside"===L.position||"center"===L.position)u=d,z=Math.max(r,a)/2>p.getTextWidth(_,S)?"#fff":c.reverse(i);else if("left"===L.position)u="right";else u="left";var w={zlevel:this._zlevelBase+1,style:{x:this._getLabelPoint(L.position,s,b,r,a,x,d),y:l+o/2,color:v.color||z,text:_,textAlign:v.align||u,textBaseline:v.baseline||"middle",textFont:S}};if(y="emphasis",L=m[y].label||L,v=L.textStyle||v,x=m[y].labelLine.length||x,L.position=L.position||m.normal.label.position,_=this.getLabelText(e,t,y),S=this.getFont(v),z=i,"inner"===L.position||"inside"===L.position||"center"===L.position)u=d,z=Math.max(r,a)/2>p.getTextWidth(_,S)?"#fff":c.reverse(i);else if("left"===L.position)u="right";else u="left";return w.highlightStyle={x:this._getLabelPoint(L.position,s,b,r,a,x,d),color:v.color||z,text:_,textAlign:v.align||u,textFont:S,brushType:"fill"},new n(w)},getLabelText:function(e,t,i){var n=this.series,s=n[e],l=s.data[t],r=this.deepQuery([l,s],"itemStyle."+i+".label.formatter");if(r){if("function"==typeof r)return r.call(this.myChart,s.name,l.name,l.value);else if("string"==typeof r)return r=r.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}"),r=r.replace("{a0}",s.name).replace("{b0}",l.name).replace("{c0}",l.value)}else return l.name},getLabelLine:function(e,t,i,n,l,r,a,o,c){var p=this.series[e],d=p.data[t],u=this._paramsMap[e].location,g=h.merge(h.clone(d.itemStyle)||{},p.itemStyle),f="normal",b=g[f].labelLine,m=g[f].labelLine.length,y=b.lineStyle||{},L=g[f].label;L.position=L.position||g.normal.label.position;var v={zlevel:this._zlevelBase+1,hoverable:!1,style:{xStart:this._getLabelLineStartPoint(n,u,r,a,c),yStart:l+o/2,xEnd:this._getLabelPoint(L.position,n,u,r,a,m,c),yEnd:l+o/2,strokeColor:y.color||i,lineType:y.type,lineWidth:y.width}};return f="emphasis",b=g[f].labelLine||b,m=g[f].labelLine.length||m,y=b.lineStyle||y,L=g[f].label||L,L.position=L.position,v.highlightStyle={xEnd:this._getLabelPoint(L.position,n,u,r,a,m,c),strokeColor:y.color||i,lineType:y.type,lineWidth:y.width},new s(v)},_getLabelPoint:function(e,t,i,n,s,l,r){switch(e="inner"===e||"inside"===e?"center":e){case"center":return"center"==r?t+n/2:"left"==r?t+10:t+n-10;case"left":if("auto"===l)return i.x-10;else return"center"==r?i.centerX-Math.max(n,s)/2-l:"right"==r?t-(s>n?s-n:0)-l:i.x-l;default:if("auto"===l)return i.x+i.width+10;else return"center"==r?i.centerX+Math.max(n,s)/2+l:"right"==r?i.x+i.width+l:t+Math.max(n,s)+l}},_getLabelLineStartPoint:function(e,t,i,n,s){return"center"==s?t.centerX:n>i?e+Math.min(i,n)/2:e+Math.max(i,n)/2},_needLabel:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()}},h.inherits(e,i),h.inherits(e,t),require("../chart").define("funnel",e),e});