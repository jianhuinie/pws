define("echarts/chart/eventRiver",["require","../component/base","./base","../layout/eventRiver","zrender/shape/Polygon","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","../util/date","zrender/tool/util","zrender/tool/color","../chart"],function(require){function e(e,r,n,l,o){t.call(this,e,r,n,l,o),i.call(this);var a=this;a._ondragend=function(){a.isDragend=!0},this.refresh(l)}var t=require("../component/base"),i=require("./base"),r=require("../layout/eventRiver"),n=require("zrender/shape/Polygon");require("../component/axis"),require("../component/grid"),require("../component/dataZoom");var l=require("../config"),o=require("../util/ecData"),a=require("../util/date"),h=require("zrender/tool/util"),s=require("zrender/tool/color");return e.prototype={type:l.CHART_TYPE_EVENTRIVER,_buildShape:function(){var e=this.series;this.selectedMap={},this._dataPreprocessing();for(var t=this.component.legend,i=[],n=0;n<e.length;n++)if(e[n].type===this.type){e[n]=this.reformOption(e[n]),this.legendHoverLink=e[n].legendHoverLink||this.legendHoverLink;var l=e[n].name||"";if(this.selectedMap[l]=t?t.isSelected(l):!0,!this.selectedMap[l])continue;this.buildMark(n),i.push(this.series[n])}r(i,this._intervalX,this.component.grid.getArea()),this._drawEventRiver(),this.addShapeList()},_dataPreprocessing:function(){for(var e,t,i=this.series,r=0,n=i.length;n>r;r++)if(i[r].type===this.type){e=this.component.xAxis.getAxis(i[r].xAxisIndex||0);for(var l=0,o=i[r].eventList.length;o>l;l++){t=i[r].eventList[l].evolution;for(var h=0,s=t.length;s>h;h++)t[h].timeScale=e.getCoord(a.getNewDate(t[h].time)-0),t[h].valueScale=Math.pow(t[h].value,.8)}}this._intervalX=Math.round(this.component.grid.getWidth()/40)},_drawEventRiver:function(){for(var e=this.series,t=0;t<e.length;t++){var i=e[t].name||"";if(e[t].type===this.type&&this.selectedMap[i])for(var r=0;r<e[t].eventList.length;r++)this._drawEventBubble(e[t].eventList[r],t,r)}},_drawEventBubble:function(e,t,i){var r=this.series,l=r[t],a=l.name||"",h=l.eventList[i],v=[h,l],u=this.component.legend,f=u?u.getColor(a):this.zr.getColor(t),d=this.deepMerge(v,"itemStyle.normal")||{},g=this.deepMerge(v,"itemStyle.emphasis")||{},c=this.getItemStyleColor(d.color,t,i,h)||f,p=this.getItemStyleColor(g.color,t,i,h)||("string"==typeof c?s.lift(c,-.2):c),m=this._calculateControlPoints(e),y={zlevel:this._zlevelBase,clickable:this.deepQuery(v,"clickable"),style:{pointList:m,smooth:"spline",brushType:"both",lineJoin:"round",color:c,lineWidth:d.borderWidth,strokeColor:d.borderColor},highlightStyle:{color:p,lineWidth:g.borderWidth,strokeColor:g.borderColor},draggable:"vertical",ondragend:this._ondragend};y=new n(y),this.addLabel(y,l,h,e.name),o.pack(y,r[t],t,r[t].eventList[i],i,r[t].eventList[i].name),this.shapeList.push(y)},_calculateControlPoints:function(e){var t=this._intervalX,i=e.y,r=e.evolution,n=r.length;if(!(1>n)){for(var l=[],o=[],a=0;n>a;a++)l.push(r[a].timeScale),o.push(r[a].valueScale);var h=[];h.push([l[0],i]);var a=0;for(a=0;n-1>a;a++)h.push([(l[a]+l[a+1])/2,o[a]/-2+i]);for(h.push([(l[a]+(l[a]+t))/2,o[a]/-2+i]),h.push([l[a]+t,i]),h.push([(l[a]+(l[a]+t))/2,o[a]/2+i]),a=n-1;a>0;a--)h.push([(l[a]+l[a-1])/2,o[a-1]/2+i]);return h}},ondragend:function(e,t){if(this.isDragend&&e.target)t.dragOut=!0,t.dragIn=!0,t.needRefresh=!1,this.isDragend=!1},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()}},h.inherits(e,i),h.inherits(e,t),require("../chart").define("eventRiver",e),e}),define("echarts/layout/eventRiver",["require"],function(){function e(e,l,o){function a(e,t){var i=e.importance,r=t.importance;return i>r?-1:r>i?1:0}function h(e,t){if(e.indexOf)return e.indexOf(t);for(var i=0,r=e.length;r>i;i++)if(e[i]===t)return i;return-1}for(var s=5,v=l,u=0;u<e.length;u++){for(var f=0;f<e[u].eventList.length;f++){if(null==e[u].eventList[f].weight)e[u].eventList[f].weight=1;for(var d=0,g=0;g<e[u].eventList[f].evolution.length;g++)d+=e[u].eventList[f].evolution[g].valueScale;e[u].eventList[f].importance=d*e[u].eventList[f].weight}e[u].eventList.sort(a)}for(var u=0;u<e.length;u++){if(null==e[u].weight)e[u].weight=1;for(var d=0,f=0;f<e[u].eventList.length;f++)d+=e[u].eventList[f].weight;e[u].importance=d*e[u].weight}e.sort(a);for(var c=Number.MAX_VALUE,p=0,u=0;u<e.length;u++)for(var f=0;f<e[u].eventList.length;f++)for(var g=0;g<e[u].eventList[f].evolution.length;g++){var m=e[u].eventList[f].evolution[g].timeScale;c=Math.min(c,m),p=Math.max(p,m)}for(var y=i(Math.floor(c),Math.ceil(p)),L=0,u=0;u<e.length;u++)for(var f=0;f<e[u].eventList.length;f++){var C=e[u].eventList[f];C.time=[],C.value=[];for(var g=0;g<e[u].eventList[f].evolution.length;g++)C.time.push(e[u].eventList[f].evolution[g].timeScale),C.value.push(e[u].eventList[f].evolution[g].valueScale);var M=h(C.value,Math.max.apply(Math,C.value)),b=r(y,C.time[M],C.time[M+1]),g=0;for(C.y=b+C.value[M]/2+s,g=0;g<C.time.length-1;g++){var S=r(y,C.time[g],C.time[g+1]);if(C.y-C.value[g]/2-s<S)C.y=S+C.value[g]/2+s}var S=r(y,C.time[g],C.time[g]+v);if(C.y-C.value[g]/2-s<S)C.y=S+C.value[g]/2+s;for(e[u].y=C.y,L=Math.max(L,C.y+C.value[M]/2),g=0;g<C.time.length-1;g++)n(y,C.time[g],C.time[g+1],C.y+C.value[g]/2);n(y,C.time[g],C.time[g]+v,C.y+C.value[g]/2)}t(e,o,L,s)}function t(e,t,i,r){for(var n=t.y,l=(t.height-r)/i,o=0;o<e.length;o++){e[o].y=e[o].y*l+n;for(var a=e[o].eventList,h=0;h<a.length;h++){a[h].y=a[h].y*l+n;for(var s=a[h].evolution,v=0;v<s.length;v++)s[v].valueScale*=1*l}}}function i(e,t){var r={left:e,right:t,leftChild:null,rightChild:null,maxValue:0};if(t>e+1){var n=Math.round((e+t)/2);r.leftChild=i(e,n),r.rightChild=i(n,t)}return r}function r(e,t,i){if(1>i-t)return 0;var n=Math.round((e.left+e.right)/2),l=0;if(t==e.left&&i==e.right)l=e.maxValue;else if(n>=i&&null!=e.leftChild)l=r(e.leftChild,t,i);else if(t>=n&&null!=e.rightChild)l=r(e.rightChild,t,i);else{var o=0,a=0;if(null!=e.leftChild)o=r(e.leftChild,t,n);if(null!=e.rightChild)a=r(e.rightChild,n,i);l=o>a?o:a}return l}function n(e,t,i,r){if(null!=e){var l=Math.round((e.left+e.right)/2);if(e.maxValue=e.maxValue>r?e.maxValue:r,Math.floor(10*t)!=Math.floor(10*e.left)||Math.floor(10*i)!=Math.floor(10*e.right))if(l>=i)n(e.leftChild,t,i,r);else if(t>=l)n(e.rightChild,t,i,r);else n(e.leftChild,t,l,r),n(e.rightChild,l,i,r)}}return e});