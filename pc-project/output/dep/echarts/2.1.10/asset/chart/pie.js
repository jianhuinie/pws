define("echarts/chart/pie",["require","../component/base","./base","zrender/shape/Text","zrender/shape/Ring","zrender/shape/Circle","zrender/shape/Sector","zrender/shape/BrokenLine","../config","../util/ecData","zrender/tool/util","zrender/tool/math","zrender/tool/color","../chart"],function(require){function e(e,i,l,a,r){t.call(this,e,i,l,a,r),s.call(this);var n=this;n.shapeHandler.onmouseover=function(e){var t=e.target,s=o.get(t,"seriesIndex"),i=o.get(t,"dataIndex"),l=o.get(t,"special"),a=[t.style.x,t.style.y],r=t.style.startAngle,h=t.style.endAngle,d=((h+r)/2+360)%360,c=t.highlightStyle.color,y=n.getLabel(s,i,l,a,d,c,!0);if(y)n.zr.addHoverShape(y);var p=n.getLabelLine(s,i,a,t.style.r0,t.style.r,d,c,!0);if(p)n.zr.addHoverShape(p)},this.refresh(a)}var t=require("../component/base"),s=require("./base"),i=require("zrender/shape/Text"),l=require("zrender/shape/Ring"),a=require("zrender/shape/Circle"),r=require("zrender/shape/Sector"),n=require("zrender/shape/BrokenLine"),h=require("../config"),o=require("../util/ecData"),d=require("zrender/tool/util"),c=require("zrender/tool/math"),y=require("zrender/tool/color");return e.prototype={type:h.CHART_TYPE_PIE,_buildShape:function(){var e=this.series,t=this.component.legend;this.selectedMap={},this._selected={};var s,i,r;this._selectedMode=!1;for(var n,d=0,c=e.length;c>d;d++)if(e[d].type===h.CHART_TYPE_PIE){if(e[d]=this.reformOption(e[d]),this.legendHoverLink=e[d].legendHoverLink||this.legendHoverLink,n=e[d].name||"",this.selectedMap[n]=t?t.isSelected(n):!0,!this.selectedMap[n])continue;if(s=this.parseCenter(this.zr,e[d].center),i=this.parseRadius(this.zr,e[d].radius),this._selectedMode=this._selectedMode||e[d].selectedMode,this._selected[d]=[],this.deepQuery([e[d],this.option],"calculable"))r={zlevel:this._zlevelBase,hoverable:!1,style:{x:s[0],y:s[1],r0:i[0]<=10?0:i[0]-10,r:i[1]+10,brushType:"stroke",lineWidth:1,strokeColor:e[d].calculableHolderColor||this.ecTheme.calculableHolderColor}},o.pack(r,e[d],d,void 0,-1),this.setCalculable(r),r=i[0]<=10?new a(r):new l(r),this.shapeList.push(r);this._buildSinglePie(d),this.buildMark(d)}this.addShapeList()},_buildSinglePie:function(e){for(var t,s=this.series,i=s[e],l=i.data,a=this.component.legend,r=0,n=0,h=0,o=Number.NEGATIVE_INFINITY,d=[],c=0,y=l.length;y>c;c++)if(t=l[c].name,this.selectedMap[t]=a?a.isSelected(t):!0,this.selectedMap[t]&&!isNaN(l[c].value)){if(0!==+l[c].value)r++;else n++;h+=+l[c].value,o=Math.max(o,+l[c].value)}if(0!==h){for(var p,u,_,f,g,b,L=100,m=i.clockWise,v=(i.startAngle.toFixed(2)-0+360)%360,x=i.minAngle||.01,S=360-x*r-.01*n,z=i.roseType,c=0,y=l.length;y>c;c++)if(t=l[c].name,this.selectedMap[t]&&!isNaN(l[c].value)){if(u=a?a.getColor(t):this.zr.getColor(c),L=l[c].value/h,"area"!=z)p=m?v-L*S-(0!==L?x:.01):L*S+v+(0!==L?x:.01);else p=m?v-360/y:360/y+v;if(p=p.toFixed(2)-0,L=(100*L).toFixed(2),_=this.parseCenter(this.zr,i.center),f=this.parseRadius(this.zr,i.radius),g=+f[0],b=+f[1],"radius"===z)b=l[c].value/o*(b-g)*.8+.2*(b-g)+g;else if("area"===z)b=Math.sqrt(l[c].value/o)*(b-g)+g;if(m){var k;k=v,v=p,p=k}if(this._buildItem(d,e,c,L,l[c].selected,_,g,b,v,p,u),!m)v=p}else;this._autoLabelLayout(d,_,b);for(var c=0,y=d.length;y>c;c++)this.shapeList.push(d[c]);d=null}},_buildItem:function(e,t,s,i,l,a,r,n,h,d,c){var y=this.series,p=((d+h)/2+360)%360,u=this.getSector(t,s,i,l,a,r,n,h,d,c);o.pack(u,y[t],t,y[t].data[s],s,y[t].data[s].name,i),e.push(u);var _=this.getLabel(t,s,i,a,p,c,!1),f=this.getLabelLine(t,s,a,r,n,p,c,!1);if(f)o.pack(f,y[t],t,y[t].data[s],s,y[t].data[s].name,i),e.push(f);if(_)o.pack(_,y[t],t,y[t].data[s],s,y[t].data[s].name,i),_._labelLine=f,e.push(_)},getSector:function(e,t,s,i,l,a,n,h,o,d){var p=this.series,u=p[e],_=u.data[t],f=[_,u],g=this.deepMerge(f,"itemStyle.normal")||{},b=this.deepMerge(f,"itemStyle.emphasis")||{},L=this.getItemStyleColor(g.color,e,t,_)||d,m=this.getItemStyleColor(b.color,e,t,_)||("string"==typeof L?y.lift(L,-.2):L),v={zlevel:this._zlevelBase,clickable:this.deepQuery(f,"clickable"),style:{x:l[0],y:l[1],r0:a,r:n,startAngle:h,endAngle:o,brushType:"both",color:L,lineWidth:g.borderWidth,strokeColor:g.borderColor,lineJoin:"round"},highlightStyle:{color:m,lineWidth:b.borderWidth,strokeColor:b.borderColor,lineJoin:"round"},_seriesIndex:e,_dataIndex:t};if(i){var x=((v.style.startAngle+v.style.endAngle)/2).toFixed(2)-0;v.style._hasSelected=!0,v.style._x=v.style.x,v.style._y=v.style.y;var S=this.query(u,"selectedOffset");v.style.x+=c.cos(x,!0)*S,v.style.y-=c.sin(x,!0)*S,this._selected[e][t]=!0}else this._selected[e][t]=!1;if(this._selectedMode)v.onclick=this.shapeHandler.onclick;if(this.deepQuery([_,u,this.option],"calculable"))this.setCalculable(v),v.draggable=!0;if(this._needLabel(u,_,!0)||this._needLabelLine(u,_,!0))v.onmouseover=this.shapeHandler.onmouseover;return v=new r(v)},getLabel:function(e,t,s,l,a,r,n){var h=this.series,o=h[e],y=o.data[t];if(this._needLabel(o,y,n)){var p,u,_,f=n?"emphasis":"normal",g=d.merge(d.clone(y.itemStyle)||{},o.itemStyle),b=g[f].label,L=b.textStyle||{},m=l[0],v=l[1],x=this.parseRadius(this.zr,o.radius),S="middle";if(b.position=b.position||g.normal.label.position,"center"===b.position)p=m,u=v,_="center";else if("inner"===b.position||"inside"===b.position)x=(x[0]+x[1])/2,p=Math.round(m+x*c.cos(a,!0)),u=Math.round(v-x*c.sin(a,!0)),r="#fff",_="center";else x=x[1]- -g[f].labelLine.length,p=Math.round(m+x*c.cos(a,!0)),u=Math.round(v-x*c.sin(a,!0)),_=a>=90&&270>=a?"right":"left";if("center"!=b.position&&"inner"!=b.position&&"inside"!=b.position)p+="left"===_?20:-20;y.__labelX=p-("left"===_?5:-5),y.__labelY=u;var z=new i({zlevel:this._zlevelBase+1,hoverable:!1,style:{x:p,y:u,color:L.color||r,text:this.getLabelText(e,t,s,f),textAlign:L.align||_,textBaseline:L.baseline||S,textFont:this.getFont(L)},highlightStyle:{brushType:"fill"}});return z._radius=x,z._labelPosition=b.position||"outer",z._rect=z.getRect(z.style),z._seriesIndex=e,z._dataIndex=t,z}},getLabelText:function(e,t,s,i){var l=this.series,a=l[e],r=a.data[t],n=this.deepQuery([r,a],"itemStyle."+i+".label.formatter");if(n){if("function"==typeof n)return n.call(this.myChart,a.name,r.name,r.value,s);else if("string"==typeof n)return n=n.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{d}","{d0}"),n=n.replace("{a0}",a.name).replace("{b0}",r.name).replace("{c0}",r.value).replace("{d0}",s)}else return r.name},getLabelLine:function(e,t,s,i,l,a,r,h){var o=this.series,y=o[e],p=y.data[t];if(this._needLabelLine(y,p,h)){var u=h?"emphasis":"normal",_=d.merge(d.clone(p.itemStyle)||{},y.itemStyle),f=_[u].labelLine,g=f.lineStyle||{},b=s[0],L=s[1],m=l,v=this.parseRadius(this.zr,y.radius)[1]- -f.length,x=c.cos(a,!0),S=c.sin(a,!0);return new n({zlevel:this._zlevelBase+1,hoverable:!1,style:{pointList:[[b+m*x,L-m*S],[b+v*x,L-v*S],[p.__labelX,p.__labelY]],strokeColor:g.color||r,lineType:g.type,lineWidth:g.width},_seriesIndex:e,_dataIndex:t})}else;},_needLabel:function(e,t,s){return this.deepQuery([t,e],"itemStyle."+(s?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,s){return this.deepQuery([t,e],"itemStyle."+(s?"emphasis":"normal")+".labelLine.show")},_autoLabelLayout:function(e,t,s){for(var i=[],l=[],a=0,r=e.length;r>a;a++)if("outer"===e[a]._labelPosition||"outside"===e[a]._labelPosition)if(e[a]._rect._y=e[a]._rect.y,e[a]._rect.x<t[0])i.push(e[a]);else l.push(e[a]);this._layoutCalculate(i,t,s,-1),this._layoutCalculate(l,t,s,1)},_layoutCalculate:function(e,t,s,i){function l(t,s,i){for(var l=t;s>l;l++){if(e[l]._rect.y+=i,e[l].style.y+=i,e[l]._labelLine)e[l]._labelLine.style.pointList[1][1]+=i,e[l]._labelLine.style.pointList[2][1]+=i;if(l>t&&s>l+1&&e[l+1]._rect.y>e[l]._rect.y+e[l]._rect.height)return void a(l,i/2)}a(s-1,i/2)}function a(t,s){for(var i=t;i>=0;i--){if(e[i]._rect.y-=s,e[i].style.y-=s,e[i]._labelLine)e[i]._labelLine.style.pointList[1][1]-=s,e[i]._labelLine.style.pointList[2][1]-=s;if(i>0&&e[i]._rect.y>e[i-1]._rect.y+e[i-1]._rect.height)break}}function r(e,t,s,i,l){for(var a,r,n,h=s[0],o=s[1],d=l>0?t?Number.MAX_VALUE:0:t?Number.MAX_VALUE:0,c=0,y=e.length;y>c;c++){if(r=Math.abs(e[c]._rect.y-o),n=e[c]._radius-i,a=i+n>r?Math.sqrt((i+n+20)*(i+n+20)-Math.pow(e[c]._rect.y-o,2)):Math.abs(e[c]._rect.x+(l>0?0:e[c]._rect.width)-h),t&&a>=d)a=d-10;if(!t&&d>=a)a=d+10;e[c]._rect.x=e[c].style.x=h+a*l,e[c]._labelLine.style.pointList[2][0]=h+(a-5)*l,e[c]._labelLine.style.pointList[1][0]=h+(a-20)*l,d=a}}e.sort(function(e,t){return e._rect.y-t._rect.y});for(var n,h=0,o=e.length,d=[],c=[],y=0;o>y;y++){if(n=e[y]._rect.y-h,0>n)l(y,o,-n,i);h=e[y]._rect.y+e[y]._rect.height}if(this.zr.getHeight()-h<0)a(o-1,h-this.zr.getHeight());for(var y=0;o>y;y++)if(e[y]._rect.y>=t[1])c.push(e[y]);else d.push(e[y]);r(c,!0,t,s,i),r(d,!1,t,s,i)},reformOption:function(e){var t=d.merge;return e=t(e||{},this.ecTheme.pie),e.itemStyle.normal.label.textStyle=t(e.itemStyle.normal.label.textStyle||{},this.ecTheme.textStyle),e.itemStyle.emphasis.label.textStyle=t(e.itemStyle.emphasis.label.textStyle||{},this.ecTheme.textStyle),e},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()},addDataAnimation:function(e){for(var t=this.series,s={},i=0,l=e.length;l>i;i++)s[e[i][0]]=e[i];var a={},r={},n={},o=this.shapeList;this.shapeList=[];for(var d,c,y,p={},i=0,l=e.length;l>i;i++)if(d=e[i][0],c=e[i][2],y=e[i][3],t[d]&&t[d].type===h.CHART_TYPE_PIE){if(c){if(!y)a[d+"_"+t[d].data.length]="delete";p[d]=1}else if(!y)a[d+"_-1"]="delete",p[d]=-1;else p[d]=0;this._buildSinglePie(d)}for(var u,_,i=0,l=this.shapeList.length;l>i;i++)switch(d=this.shapeList[i]._seriesIndex,u=this.shapeList[i]._dataIndex,_=d+"_"+u,this.shapeList[i].type){case"sector":a[_]=this.shapeList[i];break;case"text":r[_]=this.shapeList[i];break;case"broken-line":n[_]=this.shapeList[i]}this.shapeList=[];for(var f,i=0,l=o.length;l>i;i++)if(d=o[i]._seriesIndex,s[d]){if(u=o[i]._dataIndex+p[d],_=d+"_"+u,f=a[_],!f)continue;if("sector"===o[i].type)if("delete"!=f)this.zr.animate(o[i].id,"style").when(400,{startAngle:f.style.startAngle,endAngle:f.style.endAngle}).start();else this.zr.animate(o[i].id,"style").when(400,p[d]<0?{startAngle:o[i].style.startAngle}:{endAngle:o[i].style.endAngle}).start();else if("text"===o[i].type||"broken-line"===o[i].type)if("delete"===f)this.zr.delShape(o[i].id);else switch(o[i].type){case"text":f=r[_],this.zr.animate(o[i].id,"style").when(400,{x:f.style.x,y:f.style.y}).start();break;case"broken-line":f=n[_],this.zr.animate(o[i].id,"style").when(400,{pointList:f.style.pointList}).start()}}this.shapeList=o},onclick:function(e){var t=this.series;if(this.isClick&&e.target){this.isClick=!1;for(var s,i=e.target,l=i.style,a=o.get(i,"seriesIndex"),r=o.get(i,"dataIndex"),n=0,d=this.shapeList.length;d>n;n++)if(this.shapeList[n].id===i.id){if(a=o.get(i,"seriesIndex"),r=o.get(i,"dataIndex"),!l._hasSelected){var y=((l.startAngle+l.endAngle)/2).toFixed(2)-0;i.style._hasSelected=!0,this._selected[a][r]=!0,i.style._x=i.style.x,i.style._y=i.style.y,s=this.query(t[a],"selectedOffset"),i.style.x+=c.cos(y,!0)*s,i.style.y-=c.sin(y,!0)*s}else i.style.x=i.style._x,i.style.y=i.style._y,i.style._hasSelected=!1,this._selected[a][r]=!1;this.zr.modShape(i.id,i)}else if(this.shapeList[n].style._hasSelected&&"single"===this._selectedMode)a=o.get(this.shapeList[n],"seriesIndex"),r=o.get(this.shapeList[n],"dataIndex"),this.shapeList[n].style.x=this.shapeList[n].style._x,this.shapeList[n].style.y=this.shapeList[n].style._y,this.shapeList[n].style._hasSelected=!1,this._selected[a][r]=!1,this.zr.modShape(this.shapeList[n].id,this.shapeList[n]);this.messageCenter.dispatch(h.EVENT.PIE_SELECTED,e.event,{selected:this._selected,target:o.get(i,"name")},this.myChart),this.zr.refresh()}}},d.inherits(e,s),d.inherits(e,t),require("../chart").define("pie",e),e});