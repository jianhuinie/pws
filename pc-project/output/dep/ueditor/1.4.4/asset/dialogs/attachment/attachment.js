!function(){function initTabs(){for(var e=$G("tabhead").children,t=0;t<e.length;t++)domUtils.on(e[t],"click",function(e){var t=e.target||e.srcElement;setTabFocus(t.getAttribute("data-content-id"))});setTabFocus("upload")}function setTabFocus(e){if(e){var t,i,s=$G("tabhead").children;for(t=0;t<s.length;t++)if(i=s[t].getAttribute("data-content-id"),i==e)domUtils.addClass(s[t],"focus"),domUtils.addClass($G(i),"focus");else domUtils.removeClasses(s[t],"focus"),domUtils.removeClasses($G(i),"focus");switch(e){case"upload":uploadFile=uploadFile||new UploadFile("queueList");break;case"online":onlineFile=onlineFile||new OnlineFile("fileList")}}}function initButtons(){dialog.onok=function(){for(var e,t=[],i=$G("tabhead").children,s=0;s<i.length;s++)if(domUtils.hasClass(i[s],"focus")){e=i[s].getAttribute("data-content-id");break}switch(e){case"upload":t=uploadFile.getInsertList();var a=uploadFile.getQueueCount();if(a)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,a)+"</span>"),!1;break;case"online":t=onlineFile.getInsertList()}editor.execCommand("insertfile",t)}}function UploadFile(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}function OnlineFile(e){this.container=utils.isString(e)?document.getElementById(e):e,this.init()}var uploadFile,onlineFile;window.onload=function(){initTabs(),initButtons()},UploadFile.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){function e(e){var t=r('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),i=r('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(t),s=t.find("p.progress span"),a=t.find("p.imgWrap"),l=r('<p class="error"></p>').hide().appendTo(t),o=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}l.text(text).show()};if("invalid"===e.getStatus())o(e.statusText);else{if(a.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+e.ext.toLowerCase()+"|"))a.empty().addClass("notimage").append('<i class="file-preview file-type-'+e.ext.toLowerCase()+'"></i><span class="file-title" title="'+e.name+'">'+e.name+"</span>");else if(browser.ie&&browser.version<=7)a.text(lang.uploadNoPreview);else n.makeThumb(e,function(e,t){if(e||!t)a.text(lang.uploadNoPreview);else{var i=r('<img src="'+t+'">');a.empty().append(i),i.on("error",function(){a.text(lang.uploadNoPreview)})}},b,x);if(F[e.id]=[e.size,0],e.rotation=0,!e.ext||-1==k.indexOf(e.ext.toLowerCase()))o("not_allow_type"),n.removeFile(e)}e.on("statuschange",function(a,n){if("progress"===n)s.hide().width(0);else if("queued"===n)t.off("mouseenter mouseleave"),i.remove();if("error"===a||"invalid"===a)o(e.statusText),F[e.id][1]=1;else if("interrupt"===a)o("interrupt");else if("queued"===a)F[e.id][1]=0;else if("progress"===a)l.hide(),s.css("display","block");else if("complete"===a);t.removeClass("state-"+n).addClass("state-"+a)}),t.on("mouseenter",function(){i.stop().animate({height:30})}),t.on("mouseleave",function(){i.stop().animate({height:0})}),i.on("click","span",function(){var t,i=r(this).index();switch(i){case 0:return void n.removeFile(e);case 1:e.rotation+=90;break;case 2:e.rotation-=90}if(U)t="rotate("+e.rotation+"deg)",a.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t});else a.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),t.insertBefore(c)}function t(e){var t=r("#"+e.id);delete F[e.id],i(),t.off().find(".file-panel").off().end().remove()}function i(){var e,t=0,i=0,s=g.children();r.each(F,function(e,s){i+=s[0],t+=s[0]*s[1]}),e=i?t/i:0,s.eq(0).text(Math.round(100*e)+"%"),s.eq(1).css("width",Math.round(100*e)+"%"),a()}function s(e){if(e!=w){var t=n.getStats();switch(f.removeClass("state-"+w),f.addClass("state-"+e),e){case"pedding":d.addClass("element-invisible"),u.addClass("element-invisible"),h.removeClass("element-invisible"),g.hide(),p.hide(),n.refresh();break;case"ready":h.addClass("element-invisible"),d.removeClass("element-invisible"),u.removeClass("element-invisible"),g.hide(),p.show(),f.text(lang.uploadStart),n.refresh();break;case"uploading":g.show(),p.hide(),f.text(lang.uploadPause);break;case"paused":g.show(),p.hide(),f.text(lang.uploadContinue);break;case"confirm":if(g.show(),p.hide(),f.text(lang.uploadStart),t=n.getStats(),t.successNum&&!t.uploadFailNum)return void s("finish");break;case"finish":if(g.hide(),p.show(),t.uploadFailNum)f.text(lang.uploadRetry);else f.text(lang.uploadStart)}w=e,a()}if(!l.getQueueCount())f.addClass("disabled");else f.removeClass("disabled")}function a(){var e,t="";if("ready"===w)t=lang.updateStatusReady.replace("_",m).replace("_KB",WebUploader.formatSize(v));else if("confirm"===w){if(e=n.getStats(),e.uploadFailNum)t=lang.updateStatusConfirm.replace("_",e.successNum).replace("_",e.successNum)}else if(e=n.getStats(),t=lang.updateStatusFinish.replace("_",m).replace("_KB",WebUploader.formatSize(v)).replace("_",e.successNum),e.uploadFailNum)t+=lang.updateStatusError.replace("_",e.uploadFailNum);p.html(t)}var n,l=this,r=jQuery,o=l.$wrap,d=o.find(".filelist"),u=o.find(".statusBar"),p=u.find(".info"),f=o.find(".uploadBtn"),c=(o.find(".filePickerBtn"),o.find(".filePickerBlock")),h=o.find(".placeholder"),g=u.find(".progress").hide(),m=0,v=0,C=window.devicePixelRatio||1,b=113*C,x=113*C,w="",F={},U=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,t}(),S=editor.getActionUrl(editor.getOpt("fileActionName")),y=editor.getOpt("fileMaxSize"),k=(editor.getOpt("fileAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");if(!WebUploader.Uploader.support())return void r("#filePickerReady").after(r("<div>").html(lang.errorNotSupport)).hide();else if(!editor.getOpt("fileActionName"))return void r("#filePickerReady").after(r("<div>").html(lang.errorLoadConfig)).hide();n=l.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:S,fileVal:editor.getOpt("fileFieldName"),duplicate:!0,fileSingleSizeLimit:y,compress:!1}),n.addButton({id:"#filePickerBlock"}),n.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),s("pedding"),n.on("fileQueued",function(t){if(m++,v+=t.size,1===m)h.addClass("element-invisible"),u.show();e(t)}),n.on("fileDequeued",function(e){m--,v-=e.size,t(e),i()}),n.on("filesQueued",function(){if(!n.isInProgress()&&("pedding"==w||"finish"==w||"confirm"==w||"ready"==w))s("ready");i()}),n.on("all",function(e,t){switch(e){case"uploadFinished":s("confirm",t);break;case"startUpload":var i=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",a=utils.formatUrl(S+(-1==S.indexOf("?")?"?":"&")+"encode=utf-8&"+i);n.option("server",a),s("uploading",t);break;case"stopUpload":s("paused",t)}}),n.on("uploadBeforeSend",function(e,t,i){i.X_Requested_With="XMLHttpRequest"}),n.on("uploadProgress",function(e,t){var s=r("#"+e.id),a=s.find(".progress span");a.css("width",100*t+"%"),F[e.id][1]=t,i()}),n.on("uploadSuccess",function(e,t){var i=r("#"+e.id);try{var s=t._raw||t,a=utils.str2json(s);if("SUCCESS"==a.state)l.fileList.push(a),i.append('<span class="success"></span>');else i.find(".error").text(a.state).show()}catch(n){i.find(".error").text(lang.errorServerUpload).show()}}),n.on("uploadError",function(){}),n.on("error",function(t,i){if("Q_TYPE_DENIED"==t||"F_EXCEED_SIZE"==t)e(i)}),n.on("uploadComplete",function(){}),f.on("click",function(){if(r(this).hasClass("disabled"))return!1;if("ready"===w)n.upload();else if("paused"===w)n.upload();else if("uploading"===w)n.stop()}),f.addClass("state-"+w),i()},getQueueCount:function(){var e,t,i,s=0,a=this.uploader.getFiles();for(t=0;e=a[t++];)if(i=e.getStatus(),"queued"==i||"uploading"==i||"progress"==i)s++;return s},getInsertList:function(){var e,t,i,s=[],a=editor.getOpt("fileUrlPrefix");for(e=0;e<this.fileList.length;e++)i=this.fileList[e],t=i.url,s.push({title:i.original||t.substr(t.lastIndexOf("/")+1),url:a+t});return s}},OnlineFile.prototype={init:function(){this.initContainer(),this.initEvents(),this.initData()},initContainer:function(){this.container.innerHTML="",this.list=document.createElement("ul"),this.clearFloat=document.createElement("li"),domUtils.addClass(this.list,"list"),domUtils.addClass(this.clearFloat,"clearFloat"),this.list.appendChild(this.clearFloat),this.container.appendChild(this.list)},initEvents:function(){var e=this;domUtils.on($G("fileList"),"scroll",function(){var t=this;if(t.scrollHeight-(t.offsetHeight+t.scrollTop)<10)e.getFileData()}),domUtils.on(this.list,"click",function(e){var t=e.target||e.srcElement,i=t.parentNode;if("li"==i.tagName.toLowerCase())if(domUtils.hasClass(i,"selected"))domUtils.removeClasses(i,"selected");else domUtils.addClass(i,"selected")})},initData:function(){this.state=0,this.listSize=editor.getOpt("fileManagerListSize"),this.listIndex=0,this.listEnd=!1,this.getFileData()},getFileData:function(){var _this=this;if(!_this.listEnd&&!this.isLoadingData)this.isLoadingData=!0,ajax.request(editor.getActionUrl(editor.getOpt("fileManagerActionName")),{timeout:1e5,data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=eval("("+r.responseText+")");if("SUCCESS"==json.state){if(_this.pushData(json.list),_this.listIndex=parseInt(json.start)+parseInt(json.list.length),_this.listIndex>=json.total)_this.listEnd=!0;_this.isLoadingData=!1}}catch(e){if(-1!=r.responseText.indexOf("ue_separate_ue")){var list=r.responseText.split(r.responseText);_this.pushData(list),_this.listIndex=parseInt(list.length),_this.listEnd=!0,_this.isLoadingData=!1}}},onerror:function(){_this.isLoadingData=!1}})},pushData:function(e){var t,i,s,a,n,l=this,r=editor.getOpt("fileManagerUrlPrefix");for(t=0;t<e.length;t++)if(e[t]&&e[t].url){if(i=document.createElement("li"),n=document.createElement("span"),s=e[t].url.substr(e[t].url.lastIndexOf(".")+1),-1!="png|jpg|jpeg|gif|bmp".indexOf(s))a=document.createElement("img"),domUtils.on(a,"load",function(e){return function(){l.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(a)),a.width=113,a.setAttribute("src",r+e[t].url+(-1==e[t].url.indexOf("?")?"?noCache=":"&noCache=")+(+new Date).toString(36));else{var o=document.createElement("i"),d=document.createElement("span");d.innerHTML=e[t].url.substr(e[t].url.lastIndexOf("/")+1),a=document.createElement("div"),a.appendChild(o),a.appendChild(d),domUtils.addClass(a,"file-wrapper"),domUtils.addClass(d,"file-title"),domUtils.addClass(o,"file-type-"+s),domUtils.addClass(o,"file-preview")}if(domUtils.addClass(n,"icon"),i.setAttribute("data-url",r+e[t].url),e[t].original)i.setAttribute("data-title",e[t].original);i.appendChild(a),i.appendChild(n),this.list.insertBefore(i,this.clearFloat)}},scale:function(e,t,i,s){var a=e.width,n=e.height;if("justify"==s)if(a>=n)e.width=t,e.height=i*n/a,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px";else e.width=t*a/n,e.height=i,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px";else if(a>=n)e.width=t*a/n,e.height=i,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px";else e.width=t,e.height=i*n/a,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"},getInsertList:function(){var e,t=this.list.children,i=[];for(e=0;e<t.length;e++)if(domUtils.hasClass(t[e],"selected")){var s=t[e].getAttribute("data-url"),a=t[e].getAttribute("data-title")||s.substr(s.lastIndexOf("/")+1);i.push({title:a,url:s})}return i}}}();