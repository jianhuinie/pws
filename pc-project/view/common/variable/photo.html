{{ *

@file 生活照片裁剪算法

      参数：
      url: 图片 url
      raw_width： 原始图宽度
      raw_height： 原始图高度
      width: 显示宽度
      height: 显示高度

@author zhujialu

* }}
{{ strip }}

{{ $factor = 0.05 }}

{{ $parts = explode('.', $url) }}
{{ $extname = array_pop($parts) }}


{{ if empty($raw_width) || $raw_width == 0 }}
    {{ $raw_width = 1 }}
{{ /if }}

{{ if empty($width) || $width == 0 }}
    {{ $width = 1 }}
{{ /if }}

{{ if empty($height) || $height == 0 }}
    {{ $height = 1 }}
{{ /if }}

{{ if ($raw_height / $raw_width) / ($height / $width) > 1 + 2 * $factor }}

    {{ $suffix[] = "@1e_" }}
    {{ $suffix[] = $width }}
    {{ $suffix[] = "w_1c_0i_1o_90Q_1x." }}
    {{ $suffix[] = $extname }}
    {{ $suffix[] = "%7C0-" }}
    {{ $suffix[] = intval($factor * $width * $raw_height / $raw_width) }}
    {{ $suffix[] = "-" }}
    {{ $suffix[] = $width }}
    {{ $suffix[] = "-" }}
    {{ $suffix[] = $height }}
    {{ $suffix[] = "a." }}
    {{ $suffix[] = $extname }}

{{ else }}

    {{ $suffix[] = "@1e_" }}
    {{ $suffix[] = $width }}
    {{ $suffix[] = "w_" }}
    {{ $suffix[] = $height }}
    {{ $suffix[] = "h_1c_0i_1o_90Q_1x" }}
    {{ $suffix[] = "." }}
    {{ $suffix[] = $extname }}

{{ /if }}

{{ $suffix = implode("", $suffix) }}

{{ $photo = $url|cat: $suffix scope="parent" }}

{{ /strip }}